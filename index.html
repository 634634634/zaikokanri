<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* â–¼â–¼â–¼ ãƒ›ãƒ¼ãƒ ç”»é¢ï¼ˆã‚«ãƒ†ã‚´ãƒªã‚«ãƒ¼ãƒ‰ï¼‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³ â–¼â–¼â–¼ */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .category-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid #eee;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
            border-color: #4CAF50;
        }

        .category-card h3 { margin: 0 0 10px 0; color: #4CAF50; }
        .category-card .count { color: #666; font-size: 0.9rem; }
        .category-card .alert { color: #d8000c; font-weight: bold; font-size: 0.8rem; display: block; margin-top: 5px;}
    </style>
</head>
<body>

    <header>
        <div style="flex-grow: 1; overflow: hidden;">
            <h1 id="appTitle">ğŸ“¦ åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
        </div>
        <div class="month-selector">
            <label>å¯¾è±¡æœˆ: </label>
            <select id="monthSelect" onchange="changeMonth(this.value)"></select>
        </div>
    </header>

    <!-- â–¼â–¼â–¼ 1ãƒšãƒ¼ã‚¸ç›®ï¼šãƒ›ãƒ¼ãƒ ï¼ˆã‚«ãƒ†ã‚´ãƒªä¸€è¦§ï¼‰ â–¼â–¼â–¼ -->
    <div id="home-page">
        <h2>ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
        <div id="categoryGrid" class="category-grid">
            <!-- JSã§ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ -->
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚’å…ˆè¡Œã—ã¦é–‹å§‹ï¼ˆè¡¨ç¤ºé€Ÿåº¦å‘ä¸Šï¼‰
        const fetchPromise = API_URL ? fetch(API_URL).then(r => r.json()) : null;

        // çŠ¶æ…‹ç®¡ç†
        const state = {
            products: [],
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰æœˆã‚’èª­ã¿è¾¼ã‚€ã€ãªã‘ã‚Œã°ç¾åœ¨æœˆ
            currentMonth: parseInt(sessionStorage.getItem('currentMonth')) || (new Date().getMonth() + 1)
        };

        // --- åˆæœŸåŒ– ---
        async function init() {
            setupMonthSelector();
            await loadData(); // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            renderCategoryGrid();
        }

        // --- ç”»é¢é·ç§»ãƒ­ã‚¸ãƒƒã‚¯ ---
        
        // ãƒªã‚¹ãƒˆç”»é¢ã‚’è¡¨ç¤º
        window.showCategory = (categoryName) => {
            // list.html ã¸é·ç§»ï¼ˆã‚«ãƒ†ã‚´ãƒªåã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ¸¡ã™ï¼‰
            window.location.href = `list.html?category=${encodeURIComponent(categoryName)}`;
        };

        // --- æç”»ãƒ­ã‚¸ãƒƒã‚¯ ---

        // 1. ãƒ›ãƒ¼ãƒ ç”»é¢ï¼šã‚«ãƒ†ã‚´ãƒªã‚«ãƒ¼ãƒ‰ã®æç”»
        function renderCategoryGrid() {
            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = '';

            const fragment = document.createDocumentFragment(); // æç”»é«˜é€ŸåŒ–ç”¨

            // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«å•†å“ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const categoryGroups = state.products.reduce((groups, product) => {
                const cat = product.category;
                if (!groups[cat]) groups[cat] = [];
                groups[cat].push(product);
                return groups;
            }, {});

            // ã‚«ãƒ†ã‚´ãƒªåã§ã‚½ãƒ¼ãƒˆã—ã¦è¡¨ç¤º
            Object.keys(categoryGroups).sort().forEach(cat => {
                const card = createCategoryCard(cat, categoryGroups[cat]);
                fragment.appendChild(card);
            });

            grid.appendChild(fragment); // ã¾ã¨ã‚ã¦è¿½åŠ 
        }

        // ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ¼ãƒ‰ã®ç”Ÿæˆ
        function createCategoryCard(cat, items) {
            // åœ¨åº«ä¸è¶³ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const alerts = items.filter(p => isLowStock(p, state.currentMonth)).length;

            // ã‚«ãƒ†ã‚´ãƒªå†…ã®æœ€æ–°æ›´æ–°æ—¥æ™‚ã‚’æ¢ã™
            let lastUpdated = '---';
            const timestamps = items
                .map(p => p.lastUpdated)
                .filter(Boolean)
                .sort()
                .reverse();
            
            if (timestamps.length > 0) {
                lastUpdated = formatDateShort(timestamps[0]);
            }

            const card = document.createElement('div');
            card.className = 'category-card';
            card.onclick = () => showCategory(cat);
            
            card.innerHTML = `
                <h3>${cat}</h3>
                <div class="count">${items.length} å•†å“</div>
                ${alerts > 0 ? `<span class="alert">âš ï¸ ${alerts}ä»¶ã®åœ¨åº«ä¸è¶³</span>` : '<span style="color:#4CAF50; font-size:0.8rem">âœ… æ­£å¸¸</span>'}
                <div class="last-updated">æœ€çµ‚æ›´æ–°: ${lastUpdated}</div>
            `;
            return card;
        }

        function setupMonthSelector() {
            const select = document.getElementById('monthSelect');
            for (let i = 1; i <= 12; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}æœˆ`;
                if (i === state.currentMonth) option.selected = true;
                select.appendChild(option);
            }
        }

        // --- APIé€šä¿¡ ---
        async function loadData() {
            if (!API_URL) {
                alert('GASã®API URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚HTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã® API_URL å¤‰æ•°ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            try {
                // èª­ã¿è¾¼ã¿ä¸­è¡¨ç¤ºï¼ˆç°¡æ˜“ï¼‰
                document.getElementById('categoryGrid').innerHTML = '<p style="text-align:center;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
                
                // å…ˆè¡Œã—ã¦é–‹å§‹ã—ãŸé€šä¿¡ã®çµæœã‚’å¾…ã¤
                state.products = await fetchPromise;
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© ---

        window.changeMonth = (val) => {
            state.currentMonth = parseInt(val, 10);
            sessionStorage.setItem('currentMonth', state.currentMonth); // è¨­å®šã‚’ä¿å­˜
            renderCategoryGrid();
        };

        // é–‹å§‹
        init();
    </script>
</body>
</html>
