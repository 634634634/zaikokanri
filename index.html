<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼‰</title>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 10px;
            background-color: #f5f7fa;
            color: #333;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢ */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
            position: sticky; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½å¾“ã•ã›ã‚‹ */
            top: 0;
            z-index: 1000;
            background-color: #f5f7fa; /* èƒŒæ™¯è‰²ã‚’æŒ‡å®šã—ã¦é€ã‘ãªã„ã‚ˆã†ã«ã™ã‚‹ */
        }

        h1 { margin: 0; font-size: 1.5rem; }

        /* æœˆé¸æŠï¼ˆå…±é€šãƒ‘ãƒ¼ãƒ„ï¼‰ */
        .month-selector select {
            padding: 5px 10px;
            font-size: 1rem;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        /* â–¼â–¼â–¼ ç”»é¢åˆ‡ã‚Šæ›¿ãˆç”¨ã‚¹ã‚¿ã‚¤ãƒ« â–¼â–¼â–¼ */
        .page {
            display: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§éè¡¨ç¤º */
            animation: fadeIn 0.3s ease-in-out;
        }
        .page.active {
            display: block; /* activeã‚¯ãƒ©ã‚¹ãŒã¤ãã¨è¡¨ç¤º */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* â–¼â–¼â–¼ ãƒ›ãƒ¼ãƒ ç”»é¢ï¼ˆã‚«ãƒ†ã‚´ãƒªã‚«ãƒ¼ãƒ‰ï¼‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³ â–¼â–¼â–¼ */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .category-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid #eee;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
            border-color: #4CAF50;
        }

        .category-card h3 { margin: 0 0 10px 0; color: #4CAF50; }
        .category-card .count { color: #666; font-size: 0.9rem; }
        .category-card .alert { color: #d8000c; font-weight: bold; font-size: 0.8rem; display: block; margin-top: 5px;}

        /* â–¼â–¼â–¼ ãƒªã‚¹ãƒˆç”»é¢ã®ãƒ‡ã‚¶ã‚¤ãƒ³ â–¼â–¼â–¼ */
        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-btn {
            background-color: #666;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .back-btn:hover { background-color: #444; }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: middle; }
        th { background-color: #4CAF50; color: white; white-space: nowrap; }

        /* PCè¡¨ç¤ºæ™‚ã®åˆ—èª¿æ•´ */
        @media (min-width: 601px) {
            th:nth-child(2), td:nth-child(2) {
                width: 200px; /* åœ¨åº«/åŸºæº–åˆ—ã®å¹…ã‚’ç¢ºä¿ */
                text-align: center;
            }
        }

        input[type="number"] { padding: 5px; width: 60px; border: 1px solid #ccc; border-radius: 4px; text-align: right; }
        textarea { width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; box-sizing: border-box; font-size: 0.9rem;}

        .low-stock { background-color: #ffe6e6; color: #d8000c; }
        .low-stock input, .low-stock textarea { border-color: #d8000c; background-color: #fff0f0; }

        /* â–¼â–¼â–¼ ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« â–¼â–¼â–¼ */
        .save-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .save-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .save-btn:hover:not(:disabled) {
            background-color: #0b7dda;
        }
        .last-updated {
            font-size: 0.8rem;
            color: #888;
            margin-top: 8px;
            border-top: 1px solid #eee;
            padding-top: 5px;
        }

        /* â–¼â–¼â–¼ ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã®ã‚¹ã‚¿ã‚¤ãƒ« â–¼â–¼â–¼ */
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 16px;
            position: fixed;
            z-index: 2000;
            left: 50%;
            transform: translateX(-50%);
            bottom: 30px;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s, visibility 0.5s;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
        }

        /* â–¼â–¼â–¼ ã‚¹ãƒãƒ›å‘ã‘æœ€é©åŒ–ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ï¼‰ â–¼â–¼â–¼ */
        @media (max-width: 600px) {
            header {
                flex-direction: row; /* 1è¡Œã«ä¸¦ã¹ã‚‹ */
                flex-wrap: nowrap;
                gap: 8px;
                padding: 10px 5px;
            }
            
            h1 { font-size: 1.2rem; }

            .month-selector {
                display: flex;
                justify-content: flex-end;
                align-items: center;
                flex-grow: 1;
            }
            
            .month-selector select {
                width: auto;
                margin: 0 5px;
            }

            /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚«ãƒ¼ãƒ‰å‹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«å¤‰æ›´ */
            thead { display: none; }
            
            tr {
                display: block;
                display: flex; /* Flexboxã«å¤‰æ›´ */
                flex-wrap: wrap;
                margin-bottom: 8px;
                border: 1px solid #ddd;
                border-radius: 8px;
                background: #fff;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            
            td {
                display: flex;
                justify-content: space-between;
                align-items: baseline;
                padding: 4px 8px;
                border-bottom: 1px solid #eee;
                text-align: right;
            }
            
            td:last-child { border-bottom: none; }
            
            /* ãƒ©ãƒ™ãƒ«ã®è¡¨ç¤º */
            td::before {
                content: attr(data-label);
                font-weight: bold;
                color: #555;
                text-align: left;
                margin-right: 10px;
            }
            
            /* CSSã§ãƒ©ãƒ™ãƒ«ã‚’æŒ‡å®š */
            /* å•†å“ã‚³ãƒ¼ãƒ‰å‰Šé™¤ã«ä¼´ã„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿®æ­£ */
            td:nth-of-type(1) {
                justify-content: flex-start;
                text-align: left;
                font-weight: bold;
                font-size: 1rem;
                padding: 8px;
                flex: 1; /* å¹…ã‚’å¯å¤‰ã« */
                border-bottom: none;
                flex-direction: column;
                align-items: flex-start;
            }
            td:nth-of-type(1)::before { content: none; }
            td:nth-of-type(2) {
                flex: 0 0 auto; /* å¹…ã‚’ä¸­èº«ã«åˆã‚ã›ã‚‹ */
                border-bottom: none;
                padding: 8px;
            }
            td:nth-of-type(2)::before { content: none; }
            td:nth-of-type(3) {
                flex-basis: 100%; /* æ”¹è¡Œã—ã¦å…¨å¹… */
                padding: 0 8px 8px 8px;
                border-bottom: none;
            }
            td:nth-of-type(3)::before { content: none; }
            
            input[type="number"], textarea {
                font-size: 16px; /* iOSã§ã®ã‚ºãƒ¼ãƒ é˜²æ­¢ */
            }
            
            .list-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>

    <header>
        <button id="headerBackBtn" class="back-btn" onclick="history.back()" style="display:none; margin-right: 5px; padding: 5px 10px;">â†©</button>
        <div style="flex-grow: 1; overflow: hidden;">
            <h1 id="appTitle">ğŸ“¦ åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <div id="headerCategoryInfo" style="display:none; line-height: 1.2;">
                <div id="headerCategoryName" style="font-weight:bold; font-size:1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></div>
                <div id="headerLastUpdated" style="font-size:0.75rem; color:#666;"></div>
            </div>
        </div>
        <div class="month-selector">
            <label>å¯¾è±¡æœˆ: </label>
            <select id="monthSelect" onchange="changeMonth(this.value)"></select>
            <button id="saveBtn" class="save-btn" onclick="saveAllChanges()" disabled>ä¿å­˜ã™ã‚‹</button>
        </div>
    </header>

    <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ç”¨ã®è¦ç´  -->
    <div id="toast" class="toast">ä¿å­˜ã—ã¾ã—ãŸ</div>

    <!-- â–¼â–¼â–¼ 1ãƒšãƒ¼ã‚¸ç›®ï¼šãƒ›ãƒ¼ãƒ ï¼ˆã‚«ãƒ†ã‚´ãƒªä¸€è¦§ï¼‰ â–¼â–¼â–¼ -->
    <div id="home-page" class="page active">
        <h2>ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
        <div id="categoryGrid" class="category-grid">
            <!-- JSã§ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ -->
        </div>
    </div>

    <!-- â–¼â–¼â–¼ 2ãƒšãƒ¼ã‚¸ç›®ï¼šãƒªã‚¹ãƒˆï¼ˆè£½å“ä¸€è¦§ï¼‰ â–¼â–¼â–¼ -->
    <div id="list-page" class="page">
        <table id="inventoryTable">
            <thead>
                <tr>
                    <th>å•†å“å</th>
                    <th>åœ¨åº«æ•° / åŸºæº–</th>
                    <th>å‚™è€ƒ</th>
                </tr>
            </thead>
            <tbody>
                <!-- JSã§ç”Ÿæˆ -->
            </tbody>
        </table>
    </div>

    <script>
        // --- ãƒ‡ãƒ¼ã‚¿å®šç¾© ---
        // â˜…ã“ã“ã«GASã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„â˜…
        const API_URL = 'https://script.google.com/macros/s/AKfycbwiMX9rD1Vd9XhrnRZaAzuYtFgg611a1vDrIHvhHdluiX8E54nc4jtdBcABdUF8BXGq/exec'; 

        // çŠ¶æ…‹ç®¡ç†
        const state = {
            products: [],
            currentMonth: new Date().getMonth() + 1,
            currentCategoryFilter: null, // ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚«ãƒ†ã‚´ãƒªï¼ˆnullãªã‚‰ãƒ›ãƒ¼ãƒ ç”»é¢ï¼‰
            modifiedProductIds: new Set()
        };

        // --- åˆæœŸåŒ– ---
        async function init() {
            setupMonthSelector();
            
            // å±¥æ­´ç®¡ç†ã®åˆæœŸåŒ–
            history.replaceState({ page: 'home' }, '', '');
            window.addEventListener('popstate', (event) => {
                if (event.state && event.state.page === 'list') {
                    showCategory(event.state.category, false);
                } else {
                    showHome();
                }
            });

            await loadData(); // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            showHome(); // æœ€åˆã¯ãƒ›ãƒ¼ãƒ ç”»é¢ã‚’è¡¨ç¤º
        }

        // --- ç”»é¢é·ç§»ãƒ­ã‚¸ãƒƒã‚¯ ---
        
        // ãƒ›ãƒ¼ãƒ ç”»é¢ã‚’è¡¨ç¤º
        window.showHome = () => {
            state.currentCategoryFilter = null;
            document.getElementById('list-page').classList.remove('active');
            document.getElementById('home-page').classList.add('active');
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('appTitle').style.display = 'block';
            document.getElementById('headerCategoryInfo').style.display = 'none';
            document.getElementById('headerBackBtn').style.display = 'none';
            
            renderCategoryGrid(); // æœ€æ–°ã®åœ¨åº«çŠ¶æ³ã‚’åæ˜ ã—ã¦ã‚«ãƒ¼ãƒ‰ã‚’æç”»
        };

        // ãƒªã‚¹ãƒˆç”»é¢ã‚’è¡¨ç¤º
        window.showCategory = (categoryName, addHistory = true) => {
            if (addHistory) {
                history.pushState({ page: 'list', category: categoryName }, '', `#${categoryName}`);
            }
            state.currentCategoryFilter = categoryName;
            document.getElementById('home-page').classList.remove('active');
            document.getElementById('list-page').classList.add('active');
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã‚’éš ã—ã¦æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼‰
            document.getElementById('appTitle').style.display = 'none';
            document.getElementById('headerCategoryInfo').style.display = 'block';
            document.getElementById('headerCategoryName').textContent = categoryName;
            document.getElementById('headerBackBtn').style.display = 'block';
            
            renderTable();
        };

        // --- æç”»ãƒ­ã‚¸ãƒƒã‚¯ ---

        // 1. ãƒ›ãƒ¼ãƒ ç”»é¢ï¼šã‚«ãƒ†ã‚´ãƒªã‚«ãƒ¼ãƒ‰ã®æç”»
        function renderCategoryGrid() {
            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = '';

            // ã‚«ãƒ†ã‚´ãƒªã®ä¸€è¦§ã‚’å–å¾—
            const categories = [...new Set(state.products.map(p => p.category))].sort();

            categories.forEach(cat => {
                // ãã®ã‚«ãƒ†ã‚´ãƒªã«å«ã¾ã‚Œã‚‹è£½å“ã‚’å–å¾—
                const items = state.products.filter(p => p.category === cat);
                // åœ¨åº«ä¸è¶³ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const alerts = items.filter(p => {
                    return isLowStock(p);
                }).length;

                // â˜…ã‚«ãƒ†ã‚´ãƒªå†…ã®å•†å“ã‹ã‚‰æœ€æ–°ã®æ›´æ–°æ—¥æ™‚ã‚’æ¢ã™
                let lastUpdated = '---';
                const timestamps = items
                    .map(p => p.lastUpdated)
                    .filter(d => d) // ç©ºã§ãªã„ã‚‚ã®ã ã‘
                    .sort()
                    .reverse(); // æ–°ã—ã„é †
                
                if (timestamps.length > 0) {
                    lastUpdated = formatDateShort(timestamps[0]);
                }

                const card = document.createElement('div');
                card.className = 'category-card';
                card.onclick = () => showCategory(cat);
                
                card.innerHTML = `
                    <h3>${cat}</h3>
                    <div class="count">${items.length} å•†å“</div>
                    ${alerts > 0 ? `<span class="alert">âš ï¸ ${alerts}ä»¶ã®åœ¨åº«ä¸è¶³</span>` : '<span style="color:#4CAF50; font-size:0.8rem">âœ… æ­£å¸¸</span>'}
                    <div class="last-updated">æœ€çµ‚æ›´æ–°: ${lastUpdated}</div>
                `;
                grid.appendChild(card);
            });
        }

        // 2. ãƒªã‚¹ãƒˆç”»é¢ï¼šãƒ†ãƒ¼ãƒ–ãƒ«ã®æç”»
        function renderTable() {
            const tbody = document.querySelector('#inventoryTable tbody');
            tbody.innerHTML = '';

            // é¸æŠä¸­ã®ã‚«ãƒ†ã‚´ãƒªã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const filteredProducts = state.products.filter(p => p.category === state.currentCategoryFilter);

            document.getElementById('headerLastUpdated').textContent = '';

            filteredProducts.forEach(product => {
                const threshold = getThreshold(product, state.currentMonth);
                const lowStock = isLowStock(product);

                const tr = document.createElement('tr');
                if (lowStock) tr.classList.add('low-stock');

                const lastUpdated = formatDateShort(product.lastUpdated);

                tr.innerHTML = `
                    <td>
                        <div>${product.name}</div>
                        <div style="font-size: 0.75rem; color: #999; font-weight: normal; margin-top: 2px;">æ›´æ–°: ${lastUpdated}</div>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                            <input type="number" value="${product.stock}" min="0" oninput="updateStock(${product.id}, this)" onfocus="this.select()">
                            <span style="color:#666; font-size:0.9rem;">/ ${threshold}</span>
                        </div>
                    </td>
                    <td>
                        <textarea rows="1" placeholder="å‚™è€ƒ" onchange="updateRemarks(${product.id}, this.value)" oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';">${product.remarks}</textarea>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---

        function formatDateShort(dateStr) {
            if (!dateStr || dateStr === '---') return '---';
            
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;

            const month = date.getMonth() + 1;
            const day = date.getDate();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${month}/${day} ${hours}:${minutes}`;
        }

        function getThreshold(product, month) {
            if (product.monthlyOverrides && product.monthlyOverrides[month] !== undefined) {
                return product.monthlyOverrides[month];
            }
            return product.defaultThreshold;
        }

        function isLowStock(product) {
            const threshold = getThreshold(product, state.currentMonth);
            return product.stock < threshold;
        }

        function setupMonthSelector() {
            const select = document.getElementById('monthSelect');
            for (let i = 1; i <= 12; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}æœˆ`;
                if (i === state.currentMonth) option.selected = true;
                select.appendChild(option);
            }
        }

        // --- APIé€šä¿¡ ---
        async function loadData() {
            if (!API_URL) {
                alert('GASã®API URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚HTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã® API_URL å¤‰æ•°ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            try {
                // èª­ã¿è¾¼ã¿ä¸­è¡¨ç¤ºï¼ˆç°¡æ˜“ï¼‰
                document.getElementById('categoryGrid').innerHTML = '<p style="text-align:center;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
                
                const response = await fetch(API_URL);
                state.products = await response.json();
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹é–¢æ•°ï¼ˆPromiseã‚’è¿”ã™ï¼‰
        function sendData(data) {
            if (!API_URL) return;
            return fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(data)
            });
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© ---

        window.changeMonth = (val) => {
            state.currentMonth = parseInt(val, 10);
            // ç¾åœ¨è¡¨ç¤ºä¸­ã®ç”»é¢ã«åˆã‚ã›ã¦å†æç”»
            if (state.currentCategoryFilter) {
                renderTable();
            } else {
                renderCategoryGrid();
            }
        };

        window.updateStock = (id, inputElement) => {
            const newValue = inputElement.value;
            const product = state.products.find(p => p.id === id);
            if (product) {
                product.stock = parseInt(newValue, 10);
                if (isNaN(product.stock)) product.stock = 0; // ç©ºæ¬„ç­‰ã®å¯¾ç­–

                // è‰²åˆ¤å®šã®æ›´æ–°ï¼ˆå†æç”»ã›ãšã«DOMã‚’ç›´æ¥æ“ä½œã—ã¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç¶­æŒï¼‰
                const lowStock = isLowStock(product);
                const tr = inputElement.closest('tr');
                if (tr) {
                    lowStock ? tr.classList.add('low-stock') : tr.classList.remove('low-stock');
                }

                markAsModified(id); // å¤‰æ›´ã‚’è¨˜éŒ²
            }
        };

        window.updateRemarks = (id, newText) => {
            const product = state.products.find(p => p.id === id);
            if (product) {
                // å‚™è€ƒæ¬„ã®é«˜ã•èª¿æ•´ã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã®ã¿ã§å†æç”»ã¯ã—ãªã„
                product.remarks = newText;
                markAsModified(id); // å¤‰æ›´ã‚’è¨˜éŒ²
            }
        };

        // å¤‰æ›´ãŒã‚ã£ãŸã“ã¨ã‚’è¨˜éŒ²ã—ã€ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        function markAsModified(id) {
            state.modifiedProductIds.add(id);
            const btn = document.getElementById('saveBtn');
            btn.disabled = false;
            btn.textContent = `ä¿å­˜ã™ã‚‹ (${state.modifiedProductIds.size})`;
        }

        // ä¸€æ‹¬ä¿å­˜å‡¦ç†
        window.saveAllChanges = async () => {
            const btn = document.getElementById('saveBtn');
            if (state.modifiedProductIds.size === 0) return;

            btn.disabled = true;
            btn.textContent = 'ä¿å­˜ä¸­...';

            try {
                const updates = [];

                // å¤‰æ›´ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’åé›†
                state.modifiedProductIds.forEach(id => {
                    const p = state.products.find(prod => prod.id === id);
                    if (p) {
                        updates.push({ id: p.id, stock: p.stock, remarks: p.remarks });
                    }
                });

                // GASã¸ä¸€æ‹¬é€ä¿¡ï¼ˆé…åˆ—ã¨ã—ã¦é€ä¿¡ï¼‰
                await sendData(updates);

                // ä¿å­˜å®Œäº†å¾Œã€æœ€æ–°ã®æ›´æ–°æ—¥æ™‚ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§æ›´æ–°ã•ã‚ŒãŸæ—¥æ™‚ï¼‰ã‚’åæ˜ ã™ã‚‹ãŸã‚ã«å†èª­ã¿è¾¼ã¿
                await loadData();

                // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
                state.modifiedProductIds.clear();
                btn.textContent = 'ä¿å­˜ã™ã‚‹';
                showToast('ä¿å­˜ã—ã¾ã—ãŸ');

            } catch (e) {
                console.error(e);
                alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                btn.disabled = false;
                btn.textContent = `ä¿å­˜ã™ã‚‹ (${state.modifiedProductIds.size})`;
            }
        };

        // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºé–¢æ•°
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000); // 3ç§’å¾Œã«éè¡¨ç¤º
        }

        // æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚‹å ´åˆã«è­¦å‘Šã‚’è¡¨ç¤º
        window.addEventListener('beforeunload', (e) => {
            if (state.modifiedProductIds.size > 0) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // é–‹å§‹
        init();
    </script>
</body>
</html>
